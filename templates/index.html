<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Braille Dashboard Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #0b1120;
            --bg-card: #151e32;
            --bg-darker: #0f172a;
            --accent-red: #ef4444;    
            --accent-orange: #f59e0b; 
            --accent-blue: #3b82f6;
            --text-main: #f1f5f9;
            --text-muted: #64748b;
        }

        * { box-sizing: border-box; user-select: none; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-main); height: 100vh; display: flex; justify-content: center; align-items: center; }

        .dashboard { width: 98vw; height: 96vh; display: grid; grid-template-columns: 3fr 1fr; gap: 15px; }

        .panel-vista { background: var(--bg-card); border-radius: 16px; border: 1px solid #334155; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .vista-header { padding: 15px; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); height: 60px; flex-shrink: 0; }
        .header-title { font-weight: 800; color: var(--text-muted); letter-spacing: 1px; }
        
        .btn-back { background: transparent; border: 2px solid var(--accent-red); color: var(--accent-red); padding: 5px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; visibility: hidden; opacity: 0; transition: 0.3s; }
        .btn-back.visible { visibility: visible; opacity: 1; }

        .vista-body { flex: 1; display: grid; grid-template-columns: 1fr 80px; overflow: hidden; background: var(--bg-darker); }
        .braille-grid-container { padding: 10px; display: grid; grid-template-rows: repeat(15, 1fr); gap: 5px; height: 100%; }
        
        .physical-row { display: grid; grid-template-columns: 1fr 50px; gap: 10px; background: #1e293b; border-radius: 6px; align-items: center; padding: 0 5px; }
        .braille-line { display: grid; grid-template-columns: repeat(40, 1fr); gap: 2px; width: 100%; }

        .row-action-btn { width: 40px; height: 40px; background: transparent; border: 2px solid #334155; border-radius: 6px; color: #334155; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: default; transition: 0.2s; }
        .row-action-btn.is-link { border-color: var(--accent-red); color: var(--accent-red); cursor: pointer; }
        .row-action-btn.is-input { border-color: var(--accent-blue); color: var(--accent-blue); cursor: pointer; }

        .sidebar-controls { background: #1e293b; border-left: 1px solid #334155; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px; padding: 10px; }
        .scroll-arrow { width: 60px; height: 80px; background: #334155; border: none; border-radius: 12px; color: var(--accent-orange); font-size: 32px; cursor: pointer; }
        .scroll-arrow:active { transform: translateY(4px); background: var(--accent-orange); color: white; }
        .page-indicator { color: var(--text-muted); font-size: 14px; font-weight: bold; text-align: center; margin-top: 5px; }

        .b-cell { display: flex; flex-direction: column; align-items: center; width: 100%; position: relative; }
        .b-matrix { display: grid; grid-template-columns: 1fr 1fr; gap: 1px; background: #0f172a; padding: 1px; border-radius: 2px; width: 14px; height: 22px; }
        .dot { width: 100%; height: 100%; border-radius: 50%; background: #334155; }
        .dot.active { background: var(--accent-orange); box-shadow: 0 0 5px rgba(245, 158, 11, 0.5); }
        .b-char { font-size: 12px; font-weight: 900; color: var(--accent-orange); margin-top: 2px; height: 15px; overflow: hidden; text-align: center; text-shadow: 0 1px 3px rgba(0,0,0,1); }

        .panel-controls { display: flex; flex-direction: column; gap: 20px; }
        .search-trigger { width: 100%; padding: 20px; background: var(--accent-red); border: none; border-radius: 50px; color: white; font-weight: 900; font-size: 18px; cursor: pointer; text-transform: uppercase; }
        
        .modes-bar { display: flex; background: var(--bg-card); padding: 5px; border-radius: 12px; gap: 5px; }
        .mode-btn { flex: 1; background: transparent; color: var(--text-muted); padding: 8px; border: none; font-weight: bold; cursor: pointer; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; }
        .mode-btn.active { background: var(--accent-orange); color: black; }
        .mini-braille-icon { display: grid; grid-template-columns: 1fr 1fr; gap: 1px; width: 10px; height: 14px; }
        .mb-dot { width: 4px; height: 4px; background: #555; border-radius: 50%; }
        .mode-btn.active .mb-dot { background: rgba(0,0,0,0.3); }
        .mb-dot.on { background: white; }
        .mode-btn.active .mb-dot.on { background: black; }

        .keyboard { flex: 1; display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
        .key { background: #334155; border: none; border-radius: 8px; color: white; cursor: pointer; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .key:active { background: #475569; transform: translateY(2px); }
        .key.disabled { opacity: 0.2; pointer-events: none; }
        .key-main { font-size: 20px; font-weight: bold; }
        .key-enter { background: var(--accent-red); clip-path: polygon(0% 0%, 100% 0%, 100% 100%, 25% 100%, 25% 60%, 0% 60%); padding-left: 8px; }
        .bottom-actions { grid-column: span 5; display: flex; gap: 10px; height: 65px; }
        .key-space { flex: 3; background: #334155; border: none; border-radius: 8px; color: white; font-weight: bold; }
        .key-del { flex: 1; background: #b91c1c; border: none; border-radius: 8px; color: white; font-weight: bold; }
        .key-mini-dots { display: grid; grid-template-columns: 1fr 1fr; gap: 1px; width: 8px; margin-top: 4px; }
        .mini-dot { width: 3px; height: 3px; background: rgba(255,255,255,0.2); border-radius: 50%; }
        .mini-dot.on { background: white; }
    </style>
</head>
<body>

<div class="dashboard">
    <div class="panel-vista">
        <div class="vista-header">
            <span class="header-title" id="page-title">VISTA BRAILLE</span>
            <button id="btn-back" class="btn-back" onclick="goBack()">‚§∫ VOLVER</button>
        </div>

        <div class="vista-body">
            <div id="grid-container" class="braille-grid-container"></div>
            <div class="sidebar-controls">
                <button class="scroll-arrow" onclick="changePage(-1)">‚ñ≤</button>
                <span id="page-indicator" class="page-indicator">1/1</span>
                <button class="scroll-arrow" onclick="changePage(1)">‚ñº</button>
            </div>
        </div>
    </div>

    <div class="panel-controls">
        <button class="search-trigger" onclick="doSearch()">üîç BUSCAR EN WEB</button>
        
        <div class="modes-bar">
            <button class="mode-btn active" id="m-minus" onclick="setMode('minus')">
                <span>abc</span>
                <div class="mini-braille-icon"><div class="mb-dot"></div><div class="mb-dot"></div><div class="mb-dot"></div><div class="mb-dot"></div><div class="mb-dot"></div><div class="mb-dot"></div></div>
            </button>
            <button class="mode-btn" id="m-mayus" onclick="setMode('mayus')">
                <span>ABC</span>
                <div class="mini-braille-icon"><div class="mb-dot"></div><div class="mb-dot on"></div><div class="mb-dot"></div><div class="mb-dot"></div><div class="mb-dot"></div><div class="mb-dot on"></div></div>
            </button>
            <button class="mode-btn" id="m-num" onclick="setMode('num')">
                <span>123</span>
                <div class="mini-braille-icon"><div class="mb-dot"></div><div class="mb-dot on"></div><div class="mb-dot on"></div><div class="mb-dot on"></div><div class="mb-dot on"></div><div class="mb-dot on"></div></div>
            </button>
        </div>

        <div class="keyboard" id="keyboard"></div>
    </div>
</div>

<script>
    let mode = 'minus';
    let buffer = "";
    let currentState = 'home';
    let globalItems = []; 
    let isImageMode = false;
    let currentPage = 0;
    const ROWS_PER_PAGE = 15;
    const COLS_PER_ROW = 40;

    const bMap = { 'a': [1], 'b': [1,2], 'c': [1,4], 'd': [1,4,5], 'e': [1,5], 'f': [1,2,4], 'g': [1,2,4,5], 'h': [1,2,5], 'i': [2,4], 'j': [2,4,5], 'k': [1,3], 'l': [1,2,3], 'm': [1,3,4], 'n': [1,3,4,5], 'o': [1,3,5], 'p': [1,2,3,4], 'q': [1,2,3,4,5], 'r': [1,2,3,5], 's': [2,3,4], 't': [2,3,4,5], 'u': [1,3,6], 'v': [1,2,3,6], 'w': [2,4,5,6], 'x': [1,3,4,6], 'y': [1,3,4,5,6], 'z': [1,3,5,6], '√±': [1,2,4,5,6], '.': [3], ',': [2], '?': [2,6] };
    const keys = ['a','b','c','d','e','f','g','h','i','j','k','l','m','n','√±','o','p','q','r','s','t','u','v','w','x','y','z','.','?','enter'];
    const nums = ['a','b','c','d','e','f','g','h','i','j'];

    function initGrid() {
        const container = document.getElementById('grid-container');
        container.innerHTML = '';
        for(let r=0; r<ROWS_PER_PAGE; r++) {
            const rowDiv = document.createElement('div');
            rowDiv.className = 'physical-row'; rowDiv.id = `row-${r}`;
            const brailleDiv = document.createElement('div');
            brailleDiv.className = 'braille-line'; brailleDiv.id = `b-line-${r}`;
            for(let c=0; c<COLS_PER_ROW; c++) {
                const cell = document.createElement('div');
                cell.className = 'b-cell'; cell.id = `cell-${r}-${c}`;
                cell.innerHTML = `<div class="b-matrix"><div class="dot" id="d-${r}-${c}-1"></div><div class="dot" id="d-${r}-${c}-4"></div><div class="dot" id="d-${r}-${c}-2"></div><div class="dot" id="d-${r}-${c}-5"></div><div class="dot" id="d-${r}-${c}-3"></div><div class="dot" id="d-${r}-${c}-6"></div></div><span class="b-char" id="char-${r}-${c}"></span>`;
                brailleDiv.appendChild(cell);
            }
            const actionBtn = document.createElement('button');
            actionBtn.className = 'row-action-btn'; actionBtn.id = `btn-row-${r}`; actionBtn.innerHTML = '‚ûî';
            actionBtn.onclick = () => handleRowClick(r);
            rowDiv.appendChild(brailleDiv); rowDiv.appendChild(actionBtn); container.appendChild(rowDiv);
        }
    }

    function renderPage() {
        if (isImageMode) {
            document.getElementById('page-indicator').innerText = "IMG";
            const flatBraille = globalItems[0].braille;
            for(let r=0; r<ROWS_PER_PAGE; r++) {
                clearRow(r);
                document.getElementById(`btn-row-${r}`).className = 'row-action-btn'; 
                for(let c=0; c<COLS_PER_ROW; c++) {
                    const idx = (r * COLS_PER_ROW) + c;
                    if (idx < flatBraille.length) updateCell(r, c, flatBraille[idx]);
                }
            }
            return;
        }

        const totalItems = globalItems.length || 1;
        const totalPages = Math.ceil(totalItems / ROWS_PER_PAGE);
        const startIdx = currentPage * ROWS_PER_PAGE;
        document.getElementById('page-indicator').innerText = `P√ÅG ${currentPage + 1}/${totalPages}`;

        for(let r=0; r<ROWS_PER_PAGE; r++) {
            const dataIndex = startIdx + r; 
            const item = globalItems[dataIndex];
            const rowBtn = document.getElementById(`btn-row-${r}`);
            
            clearRow(r);
            rowBtn.className = 'row-action-btn'; rowBtn.innerHTML = '‚ûî';

            if (item) {
                for(let c=0; c<COLS_PER_ROW; c++) {
                    if (c < item.braille.length) updateCell(r, c, item.braille[c]);
                }
                if (item.action) {
                    if (item.action.type === 'link') rowBtn.classList.add('is-link');
                    else if (item.action.type === 'input') { rowBtn.classList.add('is-input'); rowBtn.innerHTML = '‚úé'; }
                }
            }
        }
    }

    function clearRow(r) {
        for(let c=0; c<COLS_PER_ROW; c++) {
            [1,2,3,4,5,6].forEach(p => document.getElementById(`d-${r}-${c}-${p}`).classList.remove('active'));
            document.getElementById(`char-${r}-${c}`).innerText = '';
        }
    }

    function updateCell(r, c, item) {
        if(!item) return;
        item.puntos.forEach(p => document.getElementById(`d-${r}-${c}-${p}`).classList.add('active'));
        document.getElementById(`char-${r}-${c}`).innerText = item.label || '';
    }

    function changePage(delta) {
        if (isImageMode) return;
        const totalPages = Math.ceil(globalItems.length / ROWS_PER_PAGE);
        if (totalPages === 0) return;
        const newPage = currentPage + delta;
        if (newPage >= 0 && newPage < totalPages) { currentPage = newPage; renderPage(); }
    }

    function handleRowClick(physicalRowIndex) {
        if (isImageMode) return;
        const realIndex = (currentPage * ROWS_PER_PAGE) + physicalRowIndex;
        const item = globalItems[realIndex];
        if (!item || !item.action) return;
        if (item.action.type === 'link') openUrl(item.action.url);
        else if (item.action.type === 'input') {
            const val = prompt("Escribe:");
            if(val) { buffer = val; doSearch(); }
        }
    }

    function changeState(st) {
        currentState = st;
        const btnBack = document.getElementById('btn-back');
        const title = document.getElementById('page-title');
        currentPage = 0; 
        
        if(st === 'home') { btnBack.classList.remove('visible'); title.innerText = "EDITOR (INFINITO)"; }
        else if(st === 'results') { btnBack.classList.add('visible'); title.innerText = "BUSCANDO..."; }
        else if(st === 'reader') { btnBack.classList.add('visible'); title.innerText = "LECTURA WEB"; }
    }

    async function refreshBuffer() {
        changeState('home');
        isImageMode = false;
        const res = await fetch('/traducir', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({texto: buffer}) });
        const data = await res.json();
        globalItems = data.lineas.map(l => ({braille: l, action: null}));
        if (globalItems.length > ROWS_PER_PAGE) {
            currentPage = Math.ceil(globalItems.length / ROWS_PER_PAGE) - 1;
        }
        renderPage();
    }

    async function doSearch() {
        if(!buffer && currentState === 'home') return;
        globalItems = [];
        renderPage(); 
        document.getElementById('page-indicator').innerText = "...";
        changeState('results');

        try {
            const res = await fetch('/buscar', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({consulta: buffer}) });
            globalItems = await res.json();
            
            if (globalItems.length > 0 && globalItems[0].is_image) {
                isImageMode = true;
                document.getElementById('page-title').innerText = "VISUALIZADOR GR√ÅFICO";
            } else {
                isImageMode = false;
                document.getElementById('page-title').innerText = `RESULTADOS (${globalItems.length})`;
            }
            renderPage();
        } catch(e) { alert("Error: " + e); }
    }

    async function openUrl(url) {
        changeState('reader');
        isImageMode = false;
        globalItems = [];
        renderPage();
        document.getElementById('page-indicator').innerText = "CARGANDO...";
        const res = await fetch('/navegar', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({url: url}) });
        globalItems = await res.json();
        renderPage();
    }

    function goBack() {
        if(currentState === 'reader' || isImageMode) { doSearch(); }
        else { changeState('home'); refreshBuffer(); }
    }

    async function typeKey(c) { 
        buffer += c; 
        if(currentState === 'home') refreshBuffer(); 
    }
    
    function delKey() { 
        buffer = buffer.slice(0, -1); 
        if(currentState === 'home') refreshBuffer(); 
    }

    function initKeyboard() {
        const kb = document.getElementById('keyboard'); kb.innerHTML = '';
        keys.forEach(k => {
            if(k === 'enter') {
                const btn = document.createElement('button'); btn.className = 'key key-enter'; btn.innerHTML = '‚èé'; 
                btn.onclick = () => typeKey('\n'); 
                kb.appendChild(btn); return;
            }
            let lbl = k.toUpperCase(), val = k, dis = false;
            
            if(mode === 'num') {
                const idx = nums.indexOf(k);
                if(idx >= 0) { lbl = (idx+1)%10; val = lbl.toString(); } 
                else if(!".?".includes(k)) dis = true;
            } else if(mode === 'mayus') {
                val = k.toUpperCase();
                lbl = k.toUpperCase(); 
            } else {
                lbl = k.toLowerCase();
                val = k.toLowerCase(); 
            }

            const btn = document.createElement('button'); btn.className = `key ${dis?'disabled':''}`;
            if(!dis) {
                btn.onclick = () => typeKey(val);
                let dots = ""; [1,4,2,5,3,6].forEach(p => dots+=`<div class="mini-dot ${(bMap[k]||[]).includes(p)?'on':''}"></div>`);
                btn.innerHTML = `<span class="key-main">${lbl}</span><div class="key-mini-dots">${dots}</div>`;
            } else { btn.innerHTML = `<span></span>`; }
            kb.appendChild(btn);
        });
        const row = document.createElement('div'); row.className = 'bottom-actions';
        row.innerHTML = `<button class="key-space" onclick="typeKey(' ')">ESPACIO</button><button class="key-del" onclick="delKey()">‚å´</button>`;
        kb.appendChild(row);
    }

    function setMode(m) {
        mode = m;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`m-${m}`).classList.add('active');
        initKeyboard(); 
    }

    initGrid(); initKeyboard(); refreshBuffer();
</script>
</body>
</html>